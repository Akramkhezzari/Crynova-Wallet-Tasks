<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„ÙŠÙˆÙ…ÙŠØ© - Crynova</title>
  
  <!-- Ø¥Ø¶Ø§ÙØ© Telegram Web App SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
  
  <!-- Ø¥Ø¶Ø§ÙØ© Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª FontAwesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    :root {
      --primary: #0072ff;
      --secondary: #ff2d9e;
      --accent: #7d3dff;
      --danger: #ff4757;
      --success: #26a17b;
      --warning: #ff9f00;
      --info: #2d87ff;
      --bg-light: #ffffff;
      --bg-lighter: #f8f9fa;
      --text-dark: #1a1a1a;
      --text-gray: #666;
      --text-light: #888;
      --border-light: rgba(0, 0, 0, 0.1);
      --shadow-light: rgba(0, 0, 0, 0.08);
      --chart-up: #26a17b;
      --chart-down: #ff4757;
    }

    body {
      background: #ffffff;
      color: var(--text-dark);
      min-height: 100vh;
      padding: 0;
    }

    /* ========== Ø¥Ø·Ø§Ø± Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ ========== */
    .page-frame {
      width: 100%;
      max-width: 420px;
      margin: 0 auto;
      background: #ffffff;
      /* Ø¥Ø²Ø§Ù„Ø© overflow: hidden Ù„ØªÙØ¹ÙŠÙ„ position: sticky Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­ */
      overflow: visible;
      position: relative;
      min-height: 100vh;
    }

    /* ========== Ø±Ø£Ø³ Ø§Ù„ØµÙØ­Ø© - Ø«Ø§Ø¨Øª ÙÙŠ Ø§Ù„Ø£Ø¹Ù„Ù‰ ========== */
    .page-header {
      background: linear-gradient(135deg, var(--accent), var(--primary));
      color: white;
      padding: 25px 15px 20px;
      text-align: center;
      position: sticky;
      top: 0;
      z-index: 100;
      width: 100%;
      box-shadow: 0 4px 12px rgba(0, 114, 255, 0.3);
    }

    .page-header h1 {
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: 10px;
      margin-top: 0;
    }

    .page-header p {
      opacity: 0.9;
      font-size: 0.95rem;
      margin-bottom: 0;
    }

    /* Ø²Ø± Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ - Ù†ÙØ³ ØªØµÙ…ÙŠÙ… ØµÙØ­Ø§Øª Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù… ÙˆØ§Ù„ØªØ¯Ø§ÙˆÙ„ */
    .page-close-btn {
      position: absolute;
      right: 15px;
      top: 50%;
      transform: translateY(-50%);
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      font-size: 28px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
      z-index: 11;
    }

    .page-close-btn:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: translateY(-50%) scale(1.1);
    }

    /* ========== Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ØµÙØ­Ø© ========== */
    .page-content {
      padding: 15px;
    }

    /* ========== Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ù…Ù‡Ø§Ù… ========== */
    .tasks-section {
      margin-bottom: 25px;
    }

    .section-title {
      font-size: 16px;
      font-weight: 700;
      color: var(--text-dark);
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .section-title i {
      color: var(--primary);
    }

    /* ========== Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù‡Ø§Ù… ========== */
    .tasks-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .task-item {
      background: #ffffff;
      border-radius: 12px;
      padding: 15px;
      border: 1px solid var(--border-light);
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .task-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
      border-color: var(--primary);
    }

    .task-item.completed {
      background: linear-gradient(135deg, rgba(38, 161, 123, 0.05), rgba(38, 161, 123, 0.1));
      border-color: rgba(38, 161, 123, 0.2);
    }

    .task-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 10px;
    }

    .task-title {
      font-weight: 700;
      font-size: 14px;
      color: var(--text-dark);
      flex: 1;
    }

    .task-reward {
      background: linear-gradient(135deg, var(--warning), #ffcc00);
      color: white;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .task-reward i {
      font-size: 10px;
    }

    .task-description {
      font-size: 12px;
      color: var(--text-gray);
      margin-bottom: 12px;
      line-height: 1.5;
    }

    .task-progress {
      margin-bottom: 12px;
    }

    .progress-bar {
      height: 6px;
      background: #e9ecef;
      border-radius: 3px;
      overflow: hidden;
      position: relative;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--primary), var(--secondary));
      border-radius: 3px;
      transition: width 0.5s ease;
    }

    .progress-text {
      font-size: 10px;
      color: var(--text-light);
      text-align: left;
      margin-top: 4px;
    }

    .task-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .task-status {
      font-size: 11px;
      padding: 4px 10px;
      border-radius: 12px;
      font-weight: 600;
    }

    .task-status.pending {
      background: rgba(255, 159, 0, 0.1);
      color: var(--warning);
      border: 1px solid rgba(255, 159, 0, 0.2);
    }

    .task-status.in-progress {
      background: rgba(0, 114, 255, 0.1);
      color: var(--primary);
      border: 1px solid rgba(0, 114, 255, 0.2);
    }

    .task-status.completed {
      background: rgba(38, 161, 123, 0.1);
      color: var(--success);
      border: 1px solid rgba(38, 161, 123, 0.2);
    }

    .task-status.claimed {
      background: rgba(108, 117, 125, 0.1);
      color: var(--text-gray);
      border: 1px solid rgba(108, 117, 125, 0.2);
    }

    .task-action-btn {
      padding: 8px 15px;
      border-radius: 10px;
      border: none;
      font-weight: 600;
      cursor: pointer;
      font-size: 12px;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .task-action-btn.claim {
      background: linear-gradient(90deg, var(--success), #1bc48b);
      color: white;
      box-shadow: 0 2px 8px rgba(38, 161, 123, 0.2);
    }

    .task-action-btn.claim:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(38, 161, 123, 0.3);
    }

    .task-action-btn.start {
      background: linear-gradient(90deg, var(--primary), var(--secondary));
      color: white;
      box-shadow: 0 2px 8px rgba(0, 114, 255, 0.2);
    }

    .task-action-btn.start:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 114, 255, 0.3);
    }

    .task-action-btn:disabled {
      background: #e9ecef;
      color: var(--text-light);
      cursor: not-allowed;
      box-shadow: none;
    }

    .task-action-btn:disabled:hover {
      transform: none;
      box-shadow: none;
    }

    /* ========== Ø§Ù„ØªØ­Ù…ÙŠÙ„ ÙˆØ§Ù„ØªÙˆØ¬ÙŠÙ‡Ø§Øª ========== */
    .loading-spinner {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255,255,255,0.9);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid rgba(0,114,255,0.3);
      border-radius: 50%;
      border-top-color: var(--primary);
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .toast {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--success);
      color: white;
      padding: 12px 20px;
      border-radius: 10px;
      z-index: 10000;
      font-size: 14px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      max-width: 90%;
      text-align: center;
      animation: slideDown 0.3s ease;
    }

    .toast-error {
      background: var(--danger);
    }

    .toast-warning {
      background: var(--warning);
    }

    @keyframes slideDown {
      from {
        transform: translateX(-50%) translateY(-20px);
        opacity: 0;
      }
      to {
        transform: translateX(-50%) translateY(0);
        opacity: 1;
      }
    }

    @media (max-width: 480px) {
      .page-header {
        padding: 20px 15px 18px;
      }
      
      .page-header h1 {
        font-size: 1.4rem;
      }
    }
  </style>
</head>
<body>
  <!-- ========== Ø¥Ø·Ø§Ø± Ø§Ù„ØµÙØ­Ø© ========== -->
  <div class="page-frame">
    
    <!-- ========== Ø±Ø£Ø³ Ø§Ù„ØµÙØ­Ø© - Ø«Ø§Ø¨Øª ========== -->
    <div class="page-header">
      <button class="page-close-btn" onclick="goBack()">&times;</button>
      <h1>Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</h1>
      <p>Ø£ÙƒÙ…Ù„ Ø§Ù„Ù…Ù‡Ø§Ù… ÙˆØ§Ø±Ø¨Ø­ Ø¹Ù…Ù„Ø§Øª Crynova</p>
    </div>

    <!-- ========== Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ØµÙØ­Ø© ========== -->
    <div class="page-content">
      
      <!-- ========== Ù…Ù‡Ø§Ù… Ø§Ù„ÙŠÙˆÙ… ========== -->
      <div class="tasks-section">
        <div class="section-title">
          <i class="fas fa-tasks"></i>
          Ù…Ù‡Ø§Ù… Ø§Ù„ÙŠÙˆÙ…
        </div>
        
        <div class="tasks-list" id="dailyTasksList">
          <!-- Ø³ÙŠØªÙ… Ù…Ù„Ø¤Ù‡Ø§ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ -->
        </div>
      </div>
      
      <!-- ========== Ù…Ù‡Ø§Ù… Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ ========== -->
      <div class="tasks-section">
        <div class="section-title">
          <i class="fas fa-calendar-week"></i>
          Ù…Ù‡Ø§Ù… Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹
        </div>
        
        <div class="tasks-list" id="weeklyTasksList">
          <!-- Ø³ÙŠØªÙ… Ù…Ù„Ø¤Ù‡Ø§ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ -->
        </div>
      </div>
      
    </div>
  </div>

  <!-- ========== Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ ========== -->
  <div class="loading-spinner" id="loadingSpinner">
    <div class="spinner"></div>
  </div>

  <!-- ========== Ø³ÙƒØ±ÙŠØ¨ØªØ§Øª JavaScript ========== -->
  <script>
    // ========== ØªÙ‡ÙŠØ¦Ø© Firebase ==========
    const firebaseConfig = {
      apiKey: "AIzaSyBX8v0qIVjG-Z46fVDeEUDKcPxa_FQF9Qc",
      authDomain: "bnak-belaiba.firebaseapp.com",
      projectId: "bnak-belaiba",
      storageBucket: "bnak-belaiba.firebasestorage.app",
      messagingSenderId: "286736432059",
      appId: "1:286736432059:web:ec1ed4292850f00008229e"
    };

    // ========== ØªÙ‡ÙŠØ¦Ø© Firebase ==========
    let db;
    try {
      const app = firebase.initializeApp(firebaseConfig);
      db = firebase.firestore();
      console.log('âœ… Firebase initialized successfully');
    } catch (error) {
      console.error('âŒ Firebase initialization error:', error);
    }

    // ========== Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ==========
    let currentUser = {
      id: null,
      firstName: 'Ù…Ø³ØªØ®Ø¯Ù…',
      lastName: '',
      username: null
    };

    // ========== Ø§Ù„Ø£Ø±ØµØ¯Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© (Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ù„Ù…Ø­ÙØ¸Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©) ==========
    const defaultBalances = {
      'BTC': 0.00,
      'ETH': 0.00,
      'USDT': 0.00,
      'CNC': 0.00,
      'BNB': 0.00,
      'XRP': 0.00,
      'ADA': 0.00,
      'SOL': 0.00,
      'DOT': 0.00,
      'DOGE': 0.00
    };

    // ========== Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù‡Ø§Ù… ==========
    let userTasks = {
      dailyTasks: [],
      weeklyTasks: []
    };

    // ========== Ù‚ÙˆØ§Ù„Ø¨ Ø§Ù„Ù…Ù‡Ø§Ù… ==========
    const dailyTasksTemplates = [
      {
        id: 'daily_login',
        title: 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„ÙŠÙˆÙ…ÙŠ',
        description: 'Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„Ùƒ Ø§Ù„ÙŠÙˆÙ…ÙŠ Ù„ØªØ­ØµÙ„ Ø¹Ù„Ù‰ Ù…ÙƒØ§ÙØ¢ØªÙƒ',
        reward: 0.50,
        rewardCurrency: 'CNC',
        progress: { current: 0, target: 1 },
        status: 'pending',
        action: 'login',
        icon: 'fas fa-sign-in-alt'
      },
      {
        id: 'interact_channel',
        title: 'ØªÙØ§Ø¹Ù„ Ù…Ø¹ Ø§Ø®Ø± Ù…Ù†Ø´ÙˆØ± ÙÙŠ Ø§Ù„Ù‚Ù†Ø§Ø©',
        description: 'ØªÙØ§Ø¹Ù„ Ù…Ø¹ Ø¢Ø®Ø± Ù…Ù†Ø´ÙˆØ± ÙÙŠ Ù‚Ù†Ø§Ø© Crynova Ø§Ù„Ø±Ø³Ù…ÙŠØ© Ø¹Ù„Ù‰ Telegram',
        reward: 0.25,
        rewardCurrency: 'CNC',
        progress: { current: 0, target: 1 },
        status: 'pending',
        action: 'interact_channel',
        icon: 'fas fa-bullhorn'
      },
      {
        id: 'join_channel',
        title: 'Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„Ù‚Ù†Ø§Ø©',
        description: 'Ø§Ù†Ø¶Ù… Ù„Ù‚Ù†Ø§Ø© Crynova Ø§Ù„Ø±Ø³Ù…ÙŠØ© Ø¹Ù„Ù‰ Telegram',
        reward: 0.30,
        rewardCurrency: 'CNC',
        progress: { current: 0, target: 1 },
        status: 'pending',
        action: 'join_channel',
        icon: 'fas fa-bullhorn'
      },
      {
        id: 'send_transaction',
        title: 'Ø¥Ø±Ø³Ø§Ù„ Ù…Ø¹Ø§Ù…Ù„Ø©',
        description: 'Ø£Ø±Ø³Ù„ Ø£ÙŠ Ù…Ø¨Ù„Øº Ø¥Ù„Ù‰ Ù…Ø³ØªØ®Ø¯Ù… Ø¢Ø®Ø±',
        reward: 0.27,
        rewardCurrency: 'CNC',
        progress: { current: 0, target: 1 },
        status: 'pending',
        action: 'send_transaction',
        icon: 'fas fa-paper-plane'
      }
    ];

    const weeklyTasksTemplates = [
      {
        id: 'complete_5_daily',
        title: 'Ø¥ÙƒÙ…Ø§Ù„ 5 Ù…Ù‡Ø§Ù… ÙŠÙˆÙ…ÙŠØ©',
        description: 'Ø£ÙƒÙ…Ù„ 5 Ù…Ù‡Ø§Ù… ÙŠÙˆÙ…ÙŠØ© Ù…Ø®ØªÙ„ÙØ© Ø®Ù„Ø§Ù„ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹',
        reward: 0.90,
        rewardCurrency: 'CNC',
        progress: { current: 0, target: 5 },
        status: 'pending',
        action: 'complete_daily',
        icon: 'fas fa-calendar-check'
      },
      {
        id: 'invite_3_friends',
        title: 'Ø¯Ø¹ÙˆØ© 3 Ø£ØµØ¯Ù‚Ø§Ø¡',
        description: 'Ø¯Ø¹ÙˆØ© 3 Ø£ØµØ¯Ù‚Ø§Ø¡ Ù„Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ø¥Ù„Ù‰ Crynova',
        reward: 1,
        rewardCurrency: 'CNC',
        progress: { current: 0, target: 3 },
        status: 'pending',
        action: 'invite_friends',
        icon: 'fas fa-user-friends'
      },
      {
        id: 'invite_7_friends',
        title: 'Ø¯Ø¹ÙˆØ© 7 Ø£ØµØ¯Ù‚Ø§Ø¡',
        description: 'Ø¯Ø¹ÙˆØ© 7 Ø£ØµØ¯Ù‚Ø§Ø¡ Ù„Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ø¥Ù„Ù‰ Crynova',
        reward: 2.4,
        rewardCurrency: 'CNC',
        progress: { current: 0, target: 7 },
        status: 'pending',
        action: 'invite_7_friends',
        icon: 'fas fa-user-friends'
      },
      {
        id: 'invite_15_friends',
        title: 'Ø¯Ø¹ÙˆØ© 15 ØµØ¯ÙŠÙ‚',
        description: 'Ø¯Ø¹ÙˆØ© 15 ØµØ¯ÙŠÙ‚ Ù„Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ø¥Ù„Ù‰ Crynova',
        reward: 5,
        rewardCurrency: 'CNC',
        progress: { current: 0, target: 15 },
        status: 'pending',
        action: 'invite_15_friends',
        icon: 'fas fa-user-friends'
      }
    ];

    // ========== Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© ==========
    function showLoading(show) {
      const spinner = document.getElementById('loadingSpinner');
      if (spinner) {
        spinner.style.display = show ? 'flex' : 'none';
      }
    }

    function showToast(message, type = 'info') {
      const existingToasts = document.querySelectorAll('.toast');
      existingToasts.forEach(toast => toast.remove());
      
      const toast = document.createElement('div');
      toast.className = `toast ${type === 'error' ? 'toast-error' : type === 'warning' ? 'toast-warning' : ''}`;
      toast.textContent = message;
      
      document.body.appendChild(toast);
      
      setTimeout(() => {
        if (toast.parentNode) {
          toast.style.opacity = '0';
          toast.style.transition = 'opacity 0.3s ease';
          setTimeout(() => {
            if (toast.parentNode) {
              toast.remove();
            }
          }, 300);
        }
      }, 3000);
    }

    function goBack() {
      window.history.back();
    }

    // ========== Ø¯ÙˆØ§Ù„ Firebase ==========
    async function initializeUserTasks(userId) {
      try {
        if (!db) {
          userTasks = {
            dailyTasks: JSON.parse(JSON.stringify(dailyTasksTemplates)),
            weeklyTasks: JSON.parse(JSON.stringify(weeklyTasksTemplates))
          };
          return userTasks;
        }
        
        const tasksRef = db.collection('user_tasks').doc(userId.toString());
        const tasksDoc = await tasksRef.get();
        
        if (!tasksDoc.exists) {
          const tasksData = {
            userId: userId.toString(),
            dailyTasks: JSON.parse(JSON.stringify(dailyTasksTemplates)),
            weeklyTasks: JSON.parse(JSON.stringify(weeklyTasksTemplates)),
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
          };
          
          await tasksRef.set(tasksData);
          userTasks = tasksData;
          return tasksData;
        } else {
          const tasksData = tasksDoc.data();
          userTasks = tasksData;
          return tasksData;
        }
      } catch (error) {
        console.error('âŒ Error initializing user tasks:', error);
        throw error;
      }
    }

    async function updateUserTasksInFirestore(userId, tasksData) {
      try {
        if (!db) {
          return false;
        }
        
        const tasksRef = db.collection('user_tasks').doc(userId.toString());
        await tasksRef.update({
          ...tasksData,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        console.log('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù‡Ø§Ù…');
        return true;
      } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù‡Ø§Ù…:', error);
        showToast('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù‡Ø§Ù…', 'error');
        return false;
      }
    }

    // ========== Ø¯Ø§Ù„Ø© Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ÙƒØ§ÙØ£Ø© Ø¥Ù„Ù‰ Ù…Ø­ÙØ¸Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (CNC) ==========
    async function addRewardToWallet(userId, amount, currency = 'CNC') {
      if (!db) {
        console.log(`âš ï¸ Firebase ØºÙŠØ± Ù…ØªØµÙ„ØŒ Ù…Ø­Ø§ÙƒØ§Ø© Ø¥Ø¶Ø§ÙØ© ${amount} CNC`);
        showToast(`Ù…Ø­Ø§ÙƒØ§Ø©: ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© ${amount} CNC Ø¥Ù„Ù‰ Ù…Ø­ÙØ¸ØªÙƒ`, 'success');
        return true;
      }

      try {
        const walletRef = db.collection('wallets').doc(userId.toString());
        
        await db.runTransaction(async (transaction) => {
          const walletDoc = await transaction.get(walletRef);
          
          if (!walletDoc.exists) {
            transaction.set(walletRef, {
              userId: userId.toString(),
              balances: {
                ...defaultBalances,
                CNC: amount
              },
              createdAt: firebase.firestore.FieldValue.serverTimestamp(),
              updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
          } else {
            transaction.update(walletRef, {
              'balances.CNC': firebase.firestore.FieldValue.increment(amount),
              updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
          }
        });
        
        console.log(`âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© ${amount} CNC Ø¥Ù„Ù‰ Ù…Ø­ÙØ¸Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ${userId}`);
        return true;
      } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ÙƒØ§ÙØ£Ø© Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø­ÙØ¸Ø©:', error);
        throw error;
      }
    }

    // ========== Ø¯ÙˆØ§Ù„ Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ==========
    function renderTaskList(tasks, containerId) {
      const container = document.getElementById(containerId);
      if (!container) return;
      
      container.innerHTML = '';
      
      if (!tasks || tasks.length === 0) {
        container.innerHTML = `
          <div style="text-align: center; padding: 20px; color: var(--text-light); font-size: 14px;">
            Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù‡Ø§Ù… Ø­Ø§Ù„ÙŠØ§Ù‹
          </div>
        `;
        return;
      }
      
      // Ø¥Ø°Ø§ ÙƒÙ†Ø§ Ù†Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©ØŒ Ù†Ù‚ÙˆÙ… Ø¨Ø­Ø³Ø§Ø¨ ØªÙ‚Ø¯Ù… Ù…Ù‡Ù…Ø© "Ø¥ÙƒÙ…Ø§Ù„ 5 Ù…Ù‡Ø§Ù… ÙŠÙˆÙ…ÙŠØ©"
      if (containerId === 'weeklyTasksList') {
        const weeklyTask = tasks.find(t => t.id === 'complete_5_daily');
        if (weeklyTask) {
          // Ø­Ø³Ø§Ø¨ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„ÙŠÙˆÙ…ÙŠØ© Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø© (Ø­Ø§Ù„Ø© completed Ø£Ùˆ claimed)
          const completedDailyCount = userTasks.dailyTasks.filter(t => 
            t.status === 'completed' || t.status === 'claimed'
          ).length;
          
          weeklyTask.progress.current = completedDailyCount;
          
          // Ø¥Ø°Ø§ ØªÙ… Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù‡Ø¯Ù ÙˆÙ„Ù… ØªÙƒÙ† Ø§Ù„Ù…Ù‡Ù…Ø© Ù…Ø·Ø§Ù„Ø¨ Ø¨Ù‡Ø§ØŒ Ù†ØºÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø© Ø¥Ù„Ù‰ completed
          if (completedDailyCount >= weeklyTask.progress.target && weeklyTask.status !== 'claimed') {
            weeklyTask.status = 'completed';
          } 
          // Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ… Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù‡Ø¯ÙØŒ Ù†Ø¶Ù…Ù† Ø£Ù† Ø§Ù„Ø­Ø§Ù„Ø© pending (ÙˆÙ„ÙŠØ³ in-progress)
          else if (completedDailyCount < weeklyTask.progress.target) {
            weeklyTask.status = 'pending';
          }
        }
      }
      
      tasks.forEach(task => {
        const taskElement = document.createElement('div');
        taskElement.className = `task-item ${task.status === 'completed' ? 'completed' : ''}`;
        taskElement.setAttribute('data-task-id', task.id);
        
        const progressPercent = task.progress.target > 0 ? 
          Math.min(100, (task.progress.current / task.progress.target) * 100) : 0;
        
        let actionButton = '';
        let statusText = '';
        
        switch(task.status) {
          case 'pending':
            statusText = 'Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±';
            break;
          case 'in-progress':
            statusText = 'Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°';
            break;
          case 'completed':
            statusText = 'Ù…ÙƒØªÙ…Ù„';
            break;
          case 'claimed':
            statusText = 'ØªÙ… Ø§Ù„Ù…Ø·Ø§Ù„Ø¨Ø©';
            break;
        }
        
        // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø®Ø§ØµØ© Ù„Ù…Ù‡Ù…Ø© Ø¥ÙƒÙ…Ø§Ù„ 5 Ù…Ù‡Ø§Ù… ÙŠÙˆÙ…ÙŠØ©
        if (task.id === 'complete_5_daily') {
          if (task.status === 'completed') {
            actionButton = `<button class="task-action-btn claim" onclick="claimReward('${task.id}')">
              <i class="fas fa-gift"></i>
              Ø§Ù„Ù…Ø·Ø§Ù„Ø¨Ø©
            </button>`;
          } else if (task.status === 'claimed') {
            actionButton = `<button class="task-action-btn" disabled>
              <i class="fas fa-check-circle"></i>
              Ù…Ø·Ø§Ù„Ø¨ Ø¨Ù‡
            </button>`;
          } else {
            // pending - Ø²Ø± Ù…Ø¹Ø·Ù„ Ù…Ø¹ Ø£ÙŠÙ‚ÙˆÙ†Ø© Ù‚ÙÙ„
            actionButton = `<button class="task-action-btn" disabled>
              <i class="fas fa-lock"></i>
              Ù…Ù‚ÙÙ„Ø©
            </button>`;
          }
        } else {
          // Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ù…Ù‡Ø§Ù… ØªØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ Ø·Ø¨ÙŠØ¹ÙŠ
          if (task.status === 'completed') {
            actionButton = `<button class="task-action-btn claim" onclick="claimReward('${task.id}')">
              <i class="fas fa-gift"></i>
              Ø§Ù„Ù…Ø·Ø§Ù„Ø¨Ø©
            </button>`;
          } else if (task.status === 'in-progress') {
            actionButton = `<button class="task-action-btn start" onclick="startTask('${task.id}')">
              <i class="fas fa-play"></i>
              Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ù‡Ù…Ø©
            </button>`;
          } else if (task.status === 'claimed') {
            actionButton = `<button class="task-action-btn" disabled>
              <i class="fas fa-check-circle"></i>
              Ù…Ø·Ø§Ù„Ø¨ Ø¨Ù‡
            </button>`;
          } else {
            actionButton = `<button class="task-action-btn start" onclick="startTask('${task.id}')" disabled>
              <i class="fas fa-lock"></i>
              Ù…Ù‚ÙÙ„Ø©
            </button>`;
          }
        }
        
        // ØªÙ†Ø³ÙŠÙ‚ Ø¹Ø±Ø¶ Ø§Ù„Ù…ÙƒØ§ÙØ£Ø© Ø¨Ù…Ù†Ø²Ù„ØªÙŠÙ† Ø¹Ø´Ø±ÙŠØªÙŠÙ†
        const rewardDisplay = task.reward % 1 === 0 ? task.reward : task.reward.toFixed(2);
        
        taskElement.innerHTML = `
          <div class="task-header">
            <div class="task-title">${task.title}</div>
            <div class="task-reward">
              <i class="fas fa-coins"></i>
              ${rewardDisplay} ${task.rewardCurrency}
            </div>
          </div>
          
          <div class="task-description">${task.description}</div>
          
          ${task.progress.target > 1 ? `
          <div class="task-progress">
            <div class="progress-bar">
              <div class="progress-fill" style="width: ${progressPercent}%"></div>
            </div>
            <div class="progress-text">${task.progress.current} / ${task.progress.target}</div>
          </div>
          ` : ''}
          
          <div class="task-footer">
            <div class="task-status ${task.status.replace('-', '')}">${statusText}</div>
            ${actionButton}
          </div>
        `;
        
        container.appendChild(taskElement);
      });
    }

    // ========== Ø¯ÙˆØ§Ù„ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù‡Ø§Ù… ==========
    async function startTask(taskId) {
      showLoading(true);
      
      try {
        let task = null;
        let taskType = '';
        
        task = userTasks.dailyTasks.find(t => t.id === taskId);
        if (task) taskType = 'daily';
        
        if (!task) {
          task = userTasks.weeklyTasks.find(t => t.id === taskId);
          if (task) taskType = 'weekly';
        }
        
        if (!task) {
          showToast('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù‡Ù…Ø©', 'error');
          return;
        }
        
        // Ù…Ù†Ø¹ Ø¨Ø¯Ø¡ Ù…Ù‡Ù…Ø© Ø¥ÙƒÙ…Ø§Ù„ 5 Ù…Ù‡Ø§Ù… ÙŠÙˆÙ…ÙŠØ© ÙŠØ¯ÙˆÙŠØ§Ù‹
        if (task.id === 'complete_5_daily') {
          showToast('Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¨Ø¯Ø¡ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ù‡Ù…Ø© ÙŠØ¯ÙˆÙŠØ§Ù‹ØŒ Ø³ÙŠØªÙ… Ø¥ÙƒÙ…Ø§Ù„Ù‡Ø§ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù†Ø¯ Ø¥Ù†Ø¬Ø§Ø² 5 Ù…Ù‡Ø§Ù… ÙŠÙˆÙ…ÙŠØ©', 'warning');
          return;
        }
        
        if (task.status === 'completed' || task.status === 'claimed') {
          showToast('Ù‡Ø°Ù‡ Ø§Ù„Ù…Ù‡Ù…Ø© Ù…ÙƒØªÙ…Ù„Ø© Ø¨Ø§Ù„ÙØ¹Ù„', 'warning');
          return;
        }
        
        task.status = 'in-progress';
        
        await updateUserTasksInFirestore(currentUser.id, userTasks);
        
        renderTaskList(userTasks.dailyTasks, 'dailyTasksList');
        renderTaskList(userTasks.weeklyTasks, 'weeklyTasksList');
        
        showToast('ØªÙ… Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ù‡Ù…Ø© Ø¨Ù†Ø¬Ø§Ø­!', 'success');
        
      } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ù‡Ù…Ø©:', error);
        showToast('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ù‡Ù…Ø©', 'error');
      } finally {
        showLoading(false);
      }
    }

    async function claimReward(taskId) {
      showLoading(true);
      
      try {
        let task = null;
        let taskType = '';
        
        task = userTasks.dailyTasks.find(t => t.id === taskId);
        if (task) taskType = 'daily';
        
        if (!task) {
          task = userTasks.weeklyTasks.find(t => t.id === taskId);
          if (task) taskType = 'weekly';
        }
        
        if (!task) {
          showToast('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù‡Ù…Ø©', 'error');
          return;
        }

        if (task.status !== 'completed') {
          showToast('Ù‡Ø°Ù‡ Ø§Ù„Ù…Ù‡Ù…Ø© ØºÙŠØ± Ù…ÙƒØªÙ…Ù„Ø© Ø¨Ø¹Ø¯', 'warning');
          return;
        }

        if (task.status === 'claimed') {
          showToast('ØªÙ… Ø§Ù„Ù…Ø·Ø§Ù„Ø¨Ø© Ø¨Ù‡Ø°Ù‡ Ø§Ù„Ù…ÙƒØ§ÙØ£Ø© Ù…Ø³Ø¨Ù‚Ø§Ù‹', 'warning');
          return;
        }
        
        await addRewardToWallet(currentUser.id, task.reward, task.rewardCurrency);
        
        task.status = 'claimed';
        
        await updateUserTasksInFirestore(currentUser.id, userTasks);
        
        renderTaskList(userTasks.dailyTasks, 'dailyTasksList');
        renderTaskList(userTasks.weeklyTasks, 'weeklyTasksList');
        
        showToast(`Ù…Ø¨Ø±ÙˆÙƒ! Ù„Ù‚Ø¯ ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© ${task.reward.toFixed(2)} ${task.rewardCurrency} Ø¥Ù„Ù‰ Ù…Ø­ÙØ¸ØªÙƒ`, 'success');
        
      } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…Ø·Ø§Ù„Ø¨Ø© Ø¨Ø§Ù„Ù…ÙƒØ§ÙØ£Ø©:', error);
        showToast('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…Ø·Ø§Ù„Ø¨Ø© Ø¨Ø§Ù„Ù…ÙƒØ§ÙØ£Ø©', 'error');
      } finally {
        showLoading(false);
      }
    }

    // ========== ØªÙ‡ÙŠØ¦Ø© Telegram WebApp ==========
    async function initializeTelegramWebApp() {
      try {
        if (window.Telegram && Telegram.WebApp) {
          const tg = Telegram.WebApp;
          
          tg.expand();
          tg.setBackgroundColor('#ffffff');
          
          const user = tg.initDataUnsafe.user;
          
          if (user && user.id) {
            console.log('ğŸ‘¤ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø³ØªØ®Ø¯Ù… Telegram:', user);
            
            currentUser = {
              id: user.id,
              firstName: user.first_name || 'Ù…Ø³ØªØ®Ø¯Ù…',
              lastName: user.last_name || '',
              username: user.username || null
            };
            
            const userNameElement = document.getElementById('userName');
            if (userNameElement) {
              userNameElement.textContent = `${currentUser.firstName} ${currentUser.lastName}`;
            }
            
            await initializeUserTasks(user.id);
            
            renderTaskList(userTasks.dailyTasks, 'dailyTasksList');
            renderTaskList(userTasks.weeklyTasks, 'weeklyTasksList');
            
          } else {
            console.log('âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Telegram');
            useMockData();
          }
          
        } else {
          console.log('âŒ Telegram WebApp ØºÙŠØ± Ù…ØªÙˆÙØ±');
          useMockData();
        }
      } catch (error) {
        console.error('âŒ Telegram WebApp Error:', error);
        useMockData();
      }
    }

    function useMockData() {
      const mockUser = {
        id: 5922049376,
        first_name: 'Akram',
        last_name: 'Khezzari', 
        username: 'A_mja_d_0_5'
      };
      
      currentUser = mockUser;
      
      userTasks = {
        dailyTasks: JSON.parse(JSON.stringify(dailyTasksTemplates)),
        weeklyTasks: JSON.parse(JSON.stringify(weeklyTasksTemplates))
      };
      
      // Ù…Ø­Ø§ÙƒØ§Ø© Ø¥ÙƒÙ…Ø§Ù„ Ù…Ù‡Ù…Ø© ÙŠÙˆÙ…ÙŠØ© ÙˆØ§Ø­Ø¯Ø©
      userTasks.dailyTasks[0].status = 'completed';
      userTasks.dailyTasks[0].progress.current = 1;
      
      userTasks.dailyTasks[1].status = 'in-progress';
      userTasks.dailyTasks[1].progress.current = 1;
      
      // Ø§Ù„Ù…Ù‡Ù…Ø© Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠØ© Ø³ÙŠØªÙ… ØªØ­Ø¯ÙŠØ« ØªÙ‚Ø¯Ù…Ù‡Ø§ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù†Ø¯ Ø§Ù„ØªØµÙŠÙŠØ±
      
      renderTaskList(userTasks.dailyTasks, 'dailyTasksList');
      renderTaskList(userTasks.weeklyTasks, 'weeklyTasksList');
    }

    // ========== ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØµÙØ­Ø© Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„ ==========
    document.addEventListener('DOMContentLoaded', function() {
      console.log('ğŸš€ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ ØµÙØ­Ø© Ø§Ù„Ù…Ù‡Ø§Ù…...');
      
      initializeTelegramWebApp();
      
      setTimeout(() => {
        showLoading(false);
      }, 2000);
    });
  </script>
</body>
</html>
